name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: ''
  push:
    branches:
      - main
    paths-ignore:
      - 'deployment.yaml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: {{registered_model_name}}
      REGISTRY: ghcr.io
      {% raw %}
      REPO: ${{ github.repository_owner }}/${IMAGE_NAME}
    steps:
      - name: Set lower case repo owner and image name
        run: |
          echo OWNER_LC=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]') >>${GITHUB_ENV}
          echo REPO_LC=$(echo ${REPO} | tr '[:upper:]' '[:lower:]') >>${GITHUB_ENV}
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
      - name: Set IMAGE_TAG
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
            echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
          else
            if [[ -n "${{ github.event.inputs.image_tag }}" ]]; then
              echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
            else
              echo "IMAGE_TAG=latest" >> $GITHUB_ENV
            fi
          fi
      - name: Update deployment.yaml image tag
        run: |
          sed -i "s|\(image: .*/$IMAGE_NAME:\).*|\1$IMAGE_TAG|" deployment.yaml
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG . --platform=linux/amd64 --provenance=false
          docker tag $IMAGE_NAME:$IMAGE_TAG ghcr.io/${OWNER_LC}/$IMAGE_NAME:$IMAGE_TAG
      - name: Push Docker image
        run: docker push ghcr.io/${OWNER_LC}/$IMAGE_NAME:$IMAGE_TAG

      - name: Commit updated deployment.yaml
        run: |
          git add deployment.yaml
          git commit -m "Update deployment.yaml image tag to $IMAGE_TAG" || echo "No changes to commit"
      - name: Push changes to repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD:${{ github.ref }}
        {% endraw %}